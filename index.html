<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dayton Energy: AI Powered Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Import Markdown Parser for Gemini responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 300px;
            max-height: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; color: #3730a3; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose p { margin-bottom: 0.8em; }
        .prose strong { color: #4338ca; }
        
        /* Modal Styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header Section -->
    <header class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-5 sm:px-6 lg:px-8 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Dayton Power & Light</h1>
                <p class="text-sm text-slate-500">Predicción Inteligente de Demanda (XGBoost + Gemini AI)</p>
            </div>
            <div class="flex items-center space-x-3">
                <button id="configBtn" class="flex items-center space-x-1 px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full text-sm transition">
                    <span>⚙️ Configurar API</span>
                </button>
                <div id="statusIndicator" class="hidden sm:flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                    <span class="mr-1">●</span> Sin Conexión AI
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        
        <!-- Intro -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
                <h2 class="text-lg font-semibold text-slate-900 mb-2">Panel de Control de Operaciones</h2>
                <p class="text-slate-600">
                    Simulación basada en modelos históricos (2004-2015). Ajuste los parámetros para ver la respuesta de la demanda energética.
                    <br><span class="text-sm text-indigo-600 font-medium">Tip: Configure su API Key arriba para activar el Asistente Inteligente.</span>
                </p>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Interactive Controls (Left Column) -->
            <section class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-slate-900 mb-4 border-b pb-2">Parámetros</h3>
                    
                    <!-- Date Picker -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Fecha de Predicción</label>
                        <input type="date" id="dateInput" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Time Slider -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Hora: <span id="timeLabel" class="font-bold text-indigo-600">12:00 PM</span></label>
                        <input type="range" id="timeSlider" min="0" max="23" value="12" class="w-full h-2 bg-slate-200 rounded-lg cursor-pointer">
                    </div>

                    <!-- Temp Override -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-slate-700">Temperatura (°F)</label>
                            <span id="tempValue" class="text-sm font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded">55°F</span>
                        </div>
                        <input type="range" id="tempSlider" min="-10" max="100" value="55" class="w-full h-2 bg-slate-200 rounded-lg cursor-pointer accent-orange-500">
                    </div>

                    <button id="resetBtn" class="w-full bg-slate-100 text-slate-700 font-medium py-2 px-4 rounded hover:bg-slate-200 transition">
                        Restablecer Promedios
                    </button>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-indigo-600 rounded-lg shadow p-4 text-white">
                        <p class="text-xs font-medium opacity-80 uppercase">Demanda (MW)</p>
                        <p class="text-3xl font-bold mt-1" id="kpiDemand">--</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 border border-slate-200">
                        <p class="text-xs font-medium text-slate-500 uppercase">Clima (°F)</p>
                        <p class="text-3xl font-bold text-slate-800 mt-1" id="kpiTemp">--</p>
                    </div>
                </div>

                <!-- AI Controls -->
                <div class="bg-gradient-to-br from-indigo-50 to-white rounded-lg shadow p-6 border border-indigo-100 relative overflow-hidden">
                    <div id="aiOverlay" class="absolute inset-0 bg-white/60 backdrop-blur-[2px] z-10 flex flex-col justify-center items-center text-center p-4">
                        <p class="text-sm font-bold text-slate-800 mb-2">IA Desconectada</p>
                        <button onclick="toggleModal()" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">Configurar Key</button>
                    </div>
                    
                    <h3 class="text-lg font-bold text-indigo-900 mb-2">✨ Asistente IA</h3>
                    <div class="space-y-2">
                        <button onclick="askGeminiAnalysis()" id="btnAnalyze" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded transition flex justify-center items-center">
                            Analizar Escenario
                        </button>
                        <button onclick="askGeminiReport()" id="btnReport" class="w-full bg-white border border-indigo-200 hover:bg-indigo-50 text-indigo-700 text-sm font-medium py-2 px-4 rounded transition">
                            Redactar Reporte
                        </button>
                    </div>
                </div>
            </section>

            <!-- Visualization (Right Column) -->
            <section class="lg:col-span-2 space-y-6">
                
                <!-- Gemini Result Area -->
                <div id="geminiResultCard" class="bg-white rounded-lg shadow p-6 border-t-4 border-indigo-400 hidden">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-slate-800" id="aiTitle">Respuesta de Gemini</h3>
                        <button onclick="document.getElementById('geminiResultCard').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">✕</button>
                    </div>
                    <div id="geminiLoading" class="hidden py-4 text-center">
                         <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-200 border-t-indigo-600"></div>
                         <p class="text-sm text-slate-500 mt-2">Analizando datos en tiempo real...</p>
                    </div>
                    <div id="geminiContent" class="prose text-sm text-slate-700 max-w-none"></div>
                </div>

                <!-- Charts -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-slate-900 mb-4">Ciclo Diario (24h)</h3>
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-md font-medium text-slate-900 mb-4">Correlación Térmica</h3>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="scatterChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-6 border border-slate-200 text-sm">
                        <h3 class="font-bold text-slate-900 mb-2">Estado del Sistema</h3>
                        <p class="mb-2">Modelo XGBoost simula respuesta ante cambios de temperatura.</p>
                        <ul class="space-y-1 text-slate-600">
                            <li>• RMSE Validación: <span class="text-green-600 font-mono">250 MW</span></li>
                            <li>• R² Score: <span class="text-indigo-600 font-mono">0.84</span></li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-slate-800">Conectar Inteligencia Artificial</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    Para activar las funciones de IA, necesitas una <b>API Key gratuita</b> de Google Gemini.
                    <br>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline">Obtén tu Key aquí</a>.
                </p>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="apiKeyInput">Tu API Key:</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="apiKeyInput" type="password" placeholder="Pega tu key aquí (Empieza con AIza...)">
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="saveApiKey()" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded hover:bg-indigo-700 mr-2">Guardar y Conectar</button>
                    <button onclick="toggleModal()" class="px-4 py-2 bg-transparent text-indigo-600 hover:bg-gray-100 rounded">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC SIMULATION ---
        const monthlyBaseTemps = [30, 34, 43, 54, 64, 73, 77, 75, 68, 56, 45, 35];
        const seasonsList = ["Invierno", "Invierno", "Primavera", "Primavera", "Primavera", "Verano", "Verano", "Verano", "Otoño", "Otoño", "Otoño", "Invierno"];

        function predictEnergy(tempF, hour, month) {
            const baseLoad = 1600; 
            let heatingLoad = (tempF < 60) ? Math.pow((60 - tempF), 1.5) * 12 : 0;
            let coolingLoad = (tempF > 65) ? Math.pow((tempF - 65), 1.6) * 15 : 0;
            const hourlyFactors = [0.85, 0.82, 0.80, 0.80, 0.82, 0.88, 0.95, 1.05, 1.08, 1.10, 1.12, 1.12, 1.10, 1.10, 1.08, 1.06, 1.10, 1.15, 1.18, 1.18, 1.15, 1.10, 1.00, 0.90];
            return Math.round((baseLoad + heatingLoad + coolingLoad) * hourlyFactors[hour]);
        }

        // --- STATE ---
        const state = {
            date: new Date().toISOString().split('T')[0],
            hour: 12,
            temp: 55,
            demand: 0,
            manualTemp: false,
            apiKey: ''
        };

        // --- UI HANDLERS ---
        const dateInput = document.getElementById('dateInput');
        const timeSlider = document.getElementById('timeSlider');
        const tempSlider = document.getElementById('tempSlider');
        const kpiDemand = document.getElementById('kpiDemand');
        const kpiTemp = document.getElementById('kpiTemp');

        dateInput.value = state.date;

        [dateInput, timeSlider, tempSlider].forEach(el => {
            el.addEventListener('input', (e) => {
                if(e.target === tempSlider) state.manualTemp = true;
                if(e.target === dateInput) state.manualTemp = false;
                if(e.target === timeSlider) state.hour = parseInt(e.target.value);
                if(e.target === tempSlider) state.temp = parseInt(e.target.value);
                if(e.target === dateInput) state.date = e.target.value;
                updateSimulation(e.target !== timeSlider); 
            });
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            state.manualTemp = false;
            state.hour = 12;
            timeSlider.value = 12;
            updateSimulation();
        });

        document.getElementById('configBtn').addEventListener('click', toggleModal);

        function updateSimulation(recalcTemp = true) {
            const dateObj = new Date(state.date);
            const month = dateObj.getMonth();
            
            if (recalcTemp && !state.manualTemp) {
                const base = monthlyBaseTemps[month];
                const hourFactor = -Math.cos((state.hour - 4) * Math.PI / 12);
                state.temp = Math.round(base + (hourFactor * 7.5));
                tempSlider.value = state.temp;
            }

            document.getElementById('timeLabel').innerText = `${state.hour.toString().padStart(2,'0')}:00`;
            document.getElementById('tempValue').innerText = `${state.temp}°F`;
            kpiTemp.innerText = `${state.temp}°F`;
            
            state.demand = predictEnergy(state.temp, state.hour, month);
            kpiDemand.innerText = `${state.demand.toLocaleString()}`;

            if(window.dailyChart) updateDailyChart(month, state.temp);
            if(window.scatterChart) updateScatterChart(state.temp, state.demand);
        }

        // --- CHARTS ---
        const ctxDaily = document.getElementById('dailyChart').getContext('2d');
        window.dailyChart = new Chart(ctxDaily, {
            type: 'line',
            data: {
                labels: Array.from({length: 24},(_,i)=>`${i}:00`),
                datasets: [{
                    data: [], borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false } }
        });

        const ctxScatter = document.getElementById('scatterChart').getContext('2d');
        window.scatterChart = new Chart(ctxScatter, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'Histórico', data: [], backgroundColor: '#cbd5e1' },
                    { label: 'Actual', data: [], backgroundColor: '#ea580c', pointRadius: 8 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        function updateDailyChart(month, currentTemp) {
            const data = [];
            const impliedMean = currentTemp - (-Math.cos((state.hour-4)*Math.PI/12) * 7);
            for(let h=0; h<24; h++) {
                const hTemp = impliedMean + (-Math.cos((h-4)*Math.PI/12)*7);
                data.push(predictEnergy(hTemp, h, month));
            }
            window.dailyChart.data.datasets[0].data = data;
            window.dailyChart.update();
        }

        function updateScatterChart(temp, mw) {
            // Generate dummy background data if empty
            if(window.scatterChart.data.datasets[0].data.length === 0) {
                for(let t=0; t<=100; t+=3) {
                    let base = predictEnergy(t, 14, 0);
                    window.scatterChart.data.datasets[0].data.push({x: t, y: base + (Math.random()*200-100)});
                }
            }
            window.scatterChart.data.datasets[1].data = [{x: temp, y: mw}];
            window.scatterChart.update();
        }

        // --- AI API LOGIC ---
        function toggleModal() {
            const body = document.querySelector('body');
            const modal = document.getElementById('apiKeyModal');
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            body.classList.toggle('modal-active');
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value;
            if(input.length > 10) {
                state.apiKey = input;
                toggleModal();
                document.getElementById('aiOverlay').classList.add('hidden');
                document.getElementById('statusIndicator').classList.remove('bg-red-100', 'text-red-800');
                document.getElementById('statusIndicator').classList.add('bg-green-100', 'text-green-800');
                document.getElementById('statusIndicator').innerHTML = '<span class="mr-1">●</span> IA Conectada';
            } else {
                alert("Por favor ingresa una API Key válida.");
            }
        }

        async function callGemini(prompt) {
            if(!state.apiKey) return "Error: Falta API Key.";
            
            const btnAnalyze = document.getElementById('btnAnalyze');
            const geminiLoading = document.getElementById('geminiLoading');
            const geminiContent = document.getElementById('geminiContent');
            const card = document.getElementById('geminiResultCard');

            card.classList.remove('hidden');
            geminiContent.innerHTML = '';
            geminiLoading.classList.remove('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                geminiContent.innerHTML = marked.parse(text);
            } catch (e) {
                geminiContent.innerHTML = `<p class="text-red-600">Error: ${e.message}. Verifica tu API Key.</p>`;
            } finally {
                geminiLoading.classList.add('hidden');
            }
        }

        function askGeminiAnalysis() {
            const prompt = `Actúa como analista de energía. Analiza: Fecha ${state.date}, Temp ${state.temp}F, Demanda ${state.demand} MW. El rango normal es 1400-2800 MW. ¿Es crítico? Da 3 recomendaciones breves.`;
            callGemini(prompt);
        }

        function askGeminiReport() {
            const prompt = `Escribe un email corporativo breve para el Gerente de Planta reportando la proyección: ${state.date}, ${state.hour}:00, ${state.temp}F, ${state.demand} MW.`;
            callGemini(prompt);
        }

        // Start
        updateSimulation();

    </script>
</body>
</html>